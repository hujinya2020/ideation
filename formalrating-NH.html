<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toy Design Idea Evaluation</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.4;
        }

        .instructions,
        .welcome-page,
        .end-page {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .end-page {
            text-align: center;
        }

        .welcome-page h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .main-task {
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        #ideaProgress {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1em;
            color: #2c3e50;
        }

        .idea-container {
            background-color: #e8f4f8;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        #ratingScales {
            overflow-y: auto;
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .rating-scale {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 8px;
        }

        .scale-label {
            width: 20%;
            font-size: 0.8em;
            color: #555;
        }

        .scale-label.left {
            text-align: right;
            padding-right: 10px;
        }

        .scale-label.right {
            text-align: left;
            padding-left: 10px;
        }

        .rating-options {
            display: flex;
            justify-content: space-between;
            width: 60%;
        }

        .rating-options label {
            display: inline-block;
            position: relative;
            cursor: pointer;
        }

        .rating-options input[type="radio"] {
            opacity: 0;
            position: absolute;
        }

        .radio-circle {
            display: block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid #3498db;
            transition: all 0.3s ease;
        }

        .rating-options input[type="radio"]:checked+.radio-circle {
            background-color: #3498db;
            border-color: #3498db;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            padding: 10px 0 0 0;
        }

        button {
            padding: 12px 15px;
            font-size: 14px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        #prolificId {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1em;
        }

        .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #showInstructionsBtn {
            margin-bottom: 10px;
        }

        #instructionsModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-height: 600px) {
            .modal-content {
                margin: 10px auto;
                max-height: 95vh;
            }
        }

        .emphasis-box {
            border: 2px solid #3498db;
            /* Border color */
            border-radius: 10px;
            /* Rounded corners */
            padding: 15px;
            /* Padding inside the box */
            margin-top: 20px;
            /* Margin at the top */
            background-color: #ffffff;
            /* Background color inside the box */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Shadow effect */
        }
    </style>
</head>

<body>
    <div class="welcome-page" id="welcomePage">
        <h1>Toy Design Idea Evaluation</h1>
        <div class="instructions">
            <h2>Instructions</h2>
            <p>Welcome to our toy design idea evaluation session. You will be assessing approximately 400 ideas that
                were developed based on the specific design requirements provided:</p>
            <p><em>"Please design a toy, anything a child (age 5-11) can play with by combining these two
                    concepts:<span style="color: #e74c3c;"> Mobility and Floatability</span>. The design goal is to help
                    children
                    have fun."</em></p>
            <ul>
                <li><em>Mobility: the ability to move or walk around freely</em>
                </li>
                <li><em>Floatability: the ability to stay on the surface of a liquid and not sink</em></li>
            </ul>
            <h3>Evaluation Guidelines:</h3>
            <ul>
                <li><strong>Evaluation Task:</strong> Your task is to evaluate each design idea across six
                    dimensions: novelty,
                    originality, innovativeness,
                    practicality, effectiveness, and usefulness. Rate each dimension on a scale from 1 to 7.</li>
                <li><strong>Focus on intrinsic qualities:</strong> Please focus solely on the intrinsic qualities of
                    each design, disregarding the length of description or English
                    proficiency.</li>
                <li><strong>Consistency is key:</strong> Some ideas are included as ground-truth references, and there
                    are duplicate ideas within the task. <span style="color: #e74c3c;">Inconsistent ratings or failure
                        to pass attention checks will
                        result in no payment</span>. Please make sure to maintain the same evaluation criteria
                    throughout.</li>
                <li><strong>Reference Examples:</strong> To help you calibrate your evaluation, please use the examples
                    below:
                </li>
                <div>
                    <p><strong>Novelty Score = 1:</strong></p>
                    <ul>
                        <li>A rubber duck that can be rolled around on the surface but also floats in the water when the
                            wheels are retracted.</li>
                    </ul>
                    <ul>
                        <li>An airplane toy that can be controlled via your phone or a remote control that flies around,
                            and can land on water.</li>
                    </ul>
                </div>
                <div>
                    <p><strong>Novelty Score = 7:</strong></p>
                    <ul>
                        <li>Design a float-plane with a spinning propeller. Allow a vinegar/bicarb solution to be placed
                            in the hull section of the plane, with a hole at the back allow the solution to expel and
                            move the plane in the bathtub.</li>
                    </ul>
                    <ul>
                        <li>Extremely floatable ball. Made of scientifically tested materials of names no one can
                            pronounce, the ball is aggressively buoyant and will fly out of the water at high speeds if
                            held underneath. Noses were broken during the testing of this product but it was so fun it
                            was signed off for production.</li>
                    </ul>
                </div>
            </ul>
            <p>⚠️ <span style="font-weight: bold; color: #e74c3c;">Please do not close or refresh this page once you
                    begin.</span> Doing so will terminate your session, and you'll need to start over from the
                beginning.</p>
        </div>
        <div class="center-content">
            <input type="text" id="prolificId" placeholder="Enter your Prolific ID" required>
            <button id="startButton" disabled>Start Task (20s)</button>
        </div>
    </div>

    <div class="main-task" id="mainTask" style="display: none;">
        <button id="showInstructionsBtn">Show Instructions</button>
        <div id="ideaProgress"></div>
        <div class="idea-container">
            <p id="ideaText"></p>
        </div>
        <div id="ratingScales"></div>
        <div class="navigation">
            <button id="prevButton" onclick="showPreviousIdea()">Previous</button>
            <button id="nextButton" onclick="showNextIdea()">Next</button>
        </div>
    </div>

    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Instructions</h2>
            <p>Welcome to our toy design idea evaluation session. You will be assessing approximately 400 ideas that
                were developed based on the specific design requirements provided:</p>
            <p><em>"Please design a toy, anything a child (age 5-11) can play with by combining these two
                    concepts:<span style="color: #e74c3c;"> Mobility and Floatability</span>. The design goal is to help
                    children
                    have fun."</em></p>
            <ul>
                <li><em>Mobility: the ability to move or walk around freely</em>
                </li>
                <li><em>Floatability: the ability to stay on the surface of a liquid and not sink</em></li>
            </ul>
            <h3>Evaluation Guidelines:</h3>
            <ul>
                <li><strong>Evaluation Task:</strong> Your task is to evaluate each design idea across six
                    dimensions: novelty,
                    originality, innovativeness,
                    practicality, effectiveness, and usefulness. Rate each dimension on a scale from 1 to 7.</li>
                <li><strong>Focus on intrinsic qualities:</strong> Please focus solely on the intrinsic qualities of
                    each design, disregarding the length of description or English
                    proficiency.</li>
                <li><strong>Consistency is key:</strong> Some ideas are included as ground-truth references, and there
                    are duplicate ideas within the task. <span style="color: #e74c3c;">Inconsistent ratings or failure
                        to pass attention checks will
                        result in no payment</span>. Please make sure to maintain the same evaluation criteria
                    throughout.</li>
                <li><strong>Reference Examples:</strong> To help you calibrate your evaluation, please use the examples
                    below:
                </li>
                <div>
                    <p><strong>Novelty Score = 1:</strong></p>
                    <ul>
                        <li>A rubber duck that can be rolled around on the surface but also floats in the water when the
                            wheels are retracted.</li>
                    </ul>
                    <ul>
                        <li>An airplane toy that can be controlled via your phone or a remote control that flies around,
                            and can land on water.</li>
                    </ul>
                </div>
                <div>
                    <p><strong>Novelty Score = 7:</strong></p>
                    <ul>
                        <li>Design a float-plane with a spinning propeller. Allow a vinegar/bicarb solution to be placed
                            in the hull section of the plane, with a hole at the back allow the solution to expel and
                            move the plane in the bathtub.</li>
                    </ul>
                    <ul>
                        <li>Extremely floatable ball. Made of scientifically tested materials of names no one can
                            pronounce, the ball is aggressively buoyant and will fly out of the water at high speeds if
                            held underneath. Noses were broken during the testing of this product but it was so fun it
                            was signed off for production.</li>
                    </ul>
                </div>
            </ul>
            <p>⚠️ <span style="font-weight: bold; color: #e74c3c;">Please do not close or refresh this page once you
                    begin.</span> Doing so will terminate your session, and you'll need to start over from the
                beginning.</p>
        </div>
    </div>

    <div class="end-page" id="endPage" style="display: none;">
        <h2>Thank you for your participation!</h2>
        <p>Your contribution is greatly appreciated. Here is your completion code: <span
                style="font-weight: bold">C2N47Q9M</span></p>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA_IQTZ9seX84jj94ldroWf5FMZ1GZWlec",
            authDomain: "creautd-8d7d3.firebaseapp.com",
            databaseURL: "https://creautd-8d7d3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "creautd-8d7d3",
            storageBucket: "creautd-8d7d3.appspot.com",
            messagingSenderId: "96441731480",
            appId: "1:96441731480:web:9797d7aaae86aecaa683ed",
            measurementId: "G-FSDDCEX397"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let ideas = [];
        let currentIdeaIndex = 0;
        let sessionId = '';
        let prolificId = '';
        let seed;
        let startTime, endTime;

        const scales = [
            { name: 'novelty', label: 'Novel' },
            { name: 'originality', label: 'Original' },
            { name: 'innovativeness', label: 'Innovative' },
            { name: 'practicality', label: 'Practical' },
            { name: 'effectiveness', label: 'Effective' },
            { name: 'usefulness', label: 'Useful' }
        ];

        function generateSessionId() {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 7);
            return `${timestamp}-${randomStr}`;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const startButton = document.getElementById('startButton');
            const prolificIdInput = document.getElementById('prolificId');
            const welcomePage = document.getElementById('welcomePage');
            const mainTask = document.getElementById('mainTask');
            const showInstructionsBtn = document.getElementById('showInstructionsBtn');
            const instructionsModal = document.getElementById('instructionsModal');
            const closeBtn = document.querySelector('.close');

            let countdown = 20; // LATER
            const timer = setInterval(() => {
                countdown--;
                startButton.textContent = `Start Task (${countdown}s)`;
                if (countdown === 0) {
                    clearInterval(timer);
                    startButton.textContent = 'Start Task';
                    startButton.disabled = false;
                }
            }, 1000);

            startButton.addEventListener('click', () => {
                if (prolificIdInput.value.trim() !== '') {
                    prolificId = prolificIdInput.value.trim();
                    sessionId = generateSessionId();
                    welcomePage.style.display = 'none';
                    mainTask.style.display = 'block';
                    startTime = new Date();
                    loadXLSX(); // Use loadXLSX instead of loadCSV
                } else {
                    alert('Please enter your Prolific ID before starting the task.');
                }
            });

            prolificIdInput.addEventListener('input', () => {
                startButton.disabled = prolificIdInput.value.trim() === '' || countdown > 0;
            });

            showInstructionsBtn.addEventListener('click', () => {
                instructionsModal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                instructionsModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == instructionsModal) {
                    instructionsModal.style.display = 'none';
                }
            });
        });

        function getConditionFromURL() {
            const pathname = window.location.pathname;
            const match = pathname.match(/pilotrating-(\d+)\.html$/);
            return match ? parseInt(match[1]) : 1;
        }

        function generateSessionId() {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 7);
            return `${timestamp}-${randomStr}`;
        }

        function loadXLSX() {
            fetch('https://hujinya2020.github.io/ideation/formalidea-v1-NH.xlsx')
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: ['uniqueIdeaIndex', 'idea'] });

                    console.log('Raw XLSX data:', jsonData);

                    // Remove header row if present
                    if (jsonData.length > 0 && typeof jsonData[0].uniqueIdeaIndex === 'string' &&
                        (jsonData[0].uniqueIdeaIndex.toLowerCase() === 'uniqueideaindex' ||
                            jsonData[0].uniqueIdeaIndex.toLowerCase() === 'index')) {
                        jsonData.shift();
                    }

                    ideas = jsonData
                        .filter(row => row.uniqueIdeaIndex && row.idea) // Only filter out empty rows
                        .map(row => ({
                            uniqueIdeaIndex: row.uniqueIdeaIndex,
                            idea: row.idea.toString().trim()
                        }));

                    console.log('Processed ideas:', ideas);

                    if (ideas.length === 0) {
                        throw new Error('No ideas found in XLSX file');
                    }

                    // Randomize ideas using session seed
                    seed = sessionId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    for (let i = ideas.length - 1; i > 0; i--) {
                        const j = Math.floor(seedRandom() * (i + 1));
                        [ideas[i], ideas[j]] = [ideas[j], ideas[i]];
                    }

                    createRatingScales();
                    showIdea();
                    updateProgress();
                })
                .catch(error => {
                    console.error('Error loading XLSX:', error);
                    document.getElementById('ideaText').textContent =
                        'Error loading ideas. Please check the console for details.';
                });
        }

        function createRatingScales() {
            const container = document.getElementById('ratingScales');
            container.innerHTML = ''; // Clear existing scales
            scales.forEach(scale => {
                const div = document.createElement('div');
                div.className = 'rating-scale';
                div.innerHTML = `
                <span class="scale-label left">Not at all ${scale.label}</span>
                <div class="rating-options">
                    ${[1, 2, 3, 4, 5, 6, 7].map(value => `
                        <label>
                            <input type="radio" name="${scale.name}" value="${value}">
                            <span class="radio-circle"></span>
                        </label>
                    `).join('')}
                </div>
                <span class="scale-label right">Extremely ${scale.label}</span>
            `;
                container.appendChild(div);
            });
        }

        function seedRandom() {
            seed = (seed * 9301 + 49297) % 233280;
            return seed / 233280;
        }

        function showIdea() {
            const idea = ideas[currentIdeaIndex];
            document.getElementById('ideaText').textContent = idea.idea;
            document.getElementById('prevButton').disabled = currentIdeaIndex === 0;
            document.getElementById('nextButton').disabled = false;
            document.getElementById('nextButton').textContent = currentIdeaIndex === ideas.length - 1 ? 'Finish' : 'Next';

            scales.forEach(scale => {
                const radioButtons = document.querySelectorAll(`input[name="${scale.name}"]`);
                radioButtons.forEach(radio => radio.checked = false);
            });

            loadExistingRatings();
            updateProgress();
        }

        function loadExistingRatings() {
            const ideaRef = database.ref(`formalrating-v1/${sessionId}/Ideas/idea-${currentIdeaIndex + 1}/rating`);
            ideaRef.once('value').then((snapshot) => {
                const ratings = snapshot.val();
                if (ratings) {
                    scales.forEach(scale => {
                        const radio = document.querySelector(`input[name="${scale.name}"][value="${ratings[scale.name]}"]`);
                        if (radio) {
                            radio.checked = true;
                        }
                    });
                }
            });
        }

        function updateProgress() {
            const progressElement = document.getElementById('ideaProgress');
            progressElement.textContent = `Progress: ${currentIdeaIndex + 1} / ${ideas.length}`;
        }

        function showNextIdea() {
            if (saveRatings()) {
                if (currentIdeaIndex < ideas.length - 1) {
                    currentIdeaIndex++;
                    showIdea();
                } else {
                    endTime = new Date();
                    saveTimingData();
                    showEndPage();
                }
            }
        }

        function showPreviousIdea() {
            if (saveRatings()) {
                if (currentIdeaIndex > 0) {
                    currentIdeaIndex--;
                    showIdea();
                }
            }
        }

        function saveRatings() {
            const idea = ideas[currentIdeaIndex];
            const ratings = {};
            let allRated = true;

            scales.forEach(scale => {
                const selectedRadio = document.querySelector(`input[name="${scale.name}"]:checked`);
                if (selectedRadio) {
                    ratings[scale.name] = selectedRadio.value;
                } else {
                    allRated = false;
                }
            });

            if (!allRated) {
                alert('Please rate all dimensions before proceeding.');
                return false;
            }

            const sessionRef = database.ref(`formalrating-v1/${sessionId}`);
            sessionRef.update({
                ProlificId: prolificId,
                uniqueIdeaIndex: sessionId
            });

            const ideaRef = sessionRef.child(`Ideas/idea-${currentIdeaIndex + 1}`);
            ideaRef.update({
                'idea-content': idea.idea,
                'uniqueIdeaIndex': idea.uniqueIdeaIndex,
                rating: ratings
            });

            return true;
        }

        function saveTimingData() {
            const duration = (endTime - startTime) / 1000; // Duration in seconds
            const sessionRef = database.ref(`formalrating-v1/${sessionId}`);
            sessionRef.update({
                StartTime: startTime.toISOString(),
                EndTime: endTime.toISOString(),
                Duration: duration
            });
        }

        function showEndPage() {
            document.getElementById('mainTask').style.display = 'none';
            document.getElementById('endPage').style.display = 'block';

            const durationInMinutes = ((endTime - startTime) / 60000).toFixed(2);
            const timingInfo = document.createElement('p');
            timingInfo.textContent = `You completed the task in ${durationInMinutes} minutes.`;
            document.getElementById('endPage').insertBefore(timingInfo, document.getElementById('endPage').lastElementChild);
        }
    </script>

</body>

</html>